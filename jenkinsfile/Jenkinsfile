pipeline {
    agent any

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Deploy to Dev') {
            when {
                expression { env.GIT_BRANCH?.endsWith('/dev') }
            }
            steps {
                sshPublisher(
                    publishers: [
                        sshPublisherDesc(
                            configName: 'ansible',
                            transfers: [
                                sshTransfer(
                                    sourceFiles: 'ansible/**',
                                    remoteDirectory: '/projects/multi-branch-testing'
                                )
                            ],
                            execCommand: '''
                                cd /projects/multi-branch-testing/ansible &&
                                ansible-playbook -i hosts deploy.yml --limit dev
                            '''
                        )
                    ]
                )
            }
        }

        stage('Deploy to Prod') {
            when {
                expression { env.GIT_BRANCH?.endsWith('/main') }
            }
            steps {
                sshPublisher(
                    publishers: [
                        sshPublisherDesc(
                            configName: 'ansible',
                            execCommand: '''
                                cd /projects/multi-branch-testing/ansible &&
                                ansible-playbook -i hosts deploy.yml --limit prod
                            '''
                        )
                    ]
                )
            }
        }
    }
}

